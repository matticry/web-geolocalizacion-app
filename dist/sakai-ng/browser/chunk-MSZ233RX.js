import{C as p}from"./chunk-MPAEZOI7.js";import{Y as i,aa as s,ea as l,ta as r}from"./chunk-6U6YA3Y5.js";var g={production:!0,apiUrl:"https://main.egasyasociados.com:4041/api",apiUrl2:"http://localhost:5157/api/Geocerca"};var m=class a{constructor(e){this.http=e}baseUrl=g.apiUrl+"/login";userSignal=r(this.getUsuarioFromToken());empresasDisponiblesSignal=r([]);tokenTemporalSignal=r(null);login(e,t){let o={nombreUsuario:e,contrasena:t};return this.http.post(`${this.baseUrl}/listaempresas`,o).pipe(i(n=>{this.tokenTemporalSignal.set(n.token),this.empresasDisponiblesSignal.set(n.listado)}))}loginConEmpresa(e){let t=this.tokenTemporalSignal();if(!t)throw new Error("No hay token temporal. Debe hacer login primero.");return this.http.get(`${this.baseUrl}/tokenweb?idempresa=${e}`,{headers:{Authorization:`Bearer ${t}`}}).pipe(i(o=>{localStorage.setItem("token",o.token);let n=this.empresasDisponiblesSignal().find(d=>d.id===e);n&&localStorage.setItem("empresa",JSON.stringify(n)),this.updateUserFromToken(o.token),this.tokenTemporalSignal.set(null),this.empresasDisponiblesSignal.set([])}))}decodeToken(e){try{let t=e.split(".")[1];return JSON.parse(atob(t))}catch(t){return console.error("Error al decodificar el token:",t),null}}getDecodedToken(){let e=localStorage.getItem("token");return e?this.decodeToken(e):null}getUsuarioFromToken(){return this.getDecodedToken()?.usuario||null}isTokenExpired(){let e=this.getDecodedToken(),t=e?.exp?e.exp*1e3:0;return Date.now()>t}getUserSignal(){return this.userSignal}getCurrentUser(){return this.userSignal()}updateUserFromToken(e){let o=this.decodeToken(e)?.usuario||null;this.userSignal.set(o)}isAuthenticated(){return localStorage.getItem("token")?!this.isTokenExpired():!1}getEmpresa(){let e=localStorage.getItem("empresa");return e?JSON.parse(e):null}cancelarLogin(){this.tokenTemporalSignal.set(null),this.empresasDisponiblesSignal.set([])}getToken(){return localStorage.getItem("token")}logOut(){localStorage.removeItem("token"),localStorage.removeItem("empresa"),this.userSignal.set(null),this.tokenTemporalSignal.set(null),this.empresasDisponiblesSignal.set([])}static \u0275fac=function(t){return new(t||a)(l(p))};static \u0275prov=s({token:a,factory:a.\u0275fac,providedIn:"root"})};export{g as a,m as b};
