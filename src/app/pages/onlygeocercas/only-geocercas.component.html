<!-- Contenedor principal -->
<div class="flex flex-col md:flex-row gap-8">
    <!-- Cuerpo principal: Panel izquierdo + derecho -->
    <div class="flex flex-1 flex-col lg:flex-row gap-2 sm:gap-4 overflow-hidden min-h-0">
        <!-- Panel Izquierdo - Lista de Geocercas -->
        <div class="w-full lg:w-1/4 flex flex-col">
            <div class="flex flex-col flex-1 overflow-hidden h-full bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-700 rounded-lg shadow-sm">
                <!-- Header + Toolbar MEJORADOS -->
                <div class="relative overflow-hidden p-4 bg-gradient-to-br from-white via-surface-50/80 to-surface-100/30 dark:from-surface-900 dark:via-surface-800/90 dark:to-surface-900/60 rounded-t-lg border-b border-surface-200/60 dark:border-surface-700/60">
                    <!-- Background pattern -->
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-primary-50/10 to-transparent dark:via-primary-900/5"></div>

                    <div class="relative">
                        <div class="flex gap-3 items-center">
                            <!-- Buscador mejorado -->
                            <div class="flex-1">
                                <div class="relative">
                                    <input
                                        type="text"
                                        placeholder="Buscar geocercas..."
                                        (input)="onSearch($event)"
                                        [disabled]="modoEliminacion"
                                        class="w-full py-3 pl-11 pr-12 text-sm rounded-xl border-2 border-surface-200/80 dark:border-surface-600/80 bg-gradient-to-r from-white to-surface-50/50 dark:from-surface-800 dark:to-surface-800/80 hover:border-primary-300/60 dark:hover:border-primary-600/60 focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500/80 transition-all duration-200
                                         shadow-sm">
                                        <div class="absolute left-3.5 top-1/2 transform -translate-y-1/2">
                                            <i class="pi pi-search text-primary-400 dark:text-primary-500"></i>
                                        </div>
                                </div>
                                @if (filteredGeocercas.length > 0) {
                                    <div class="mt-3 flex justify-between items-center text-xs text-surface-600 dark:text-surface-400">
                                        <span>{{ filteredGeocercas.length }} geocercas encontradas</span>
                                    </div>

                                }
                            </div>


                            <!-- Botón de modo eliminación mejorado -->
                            <button
                                [class]="'relative overflow-hidden mb-6 w-12 h-12 flex items-center justify-center rounded-xl border-2 transition-all duration-300 shadow-sm ' + (modoEliminacion ? 'bg-gradient-to-br from-red-500 to-red-600 border-red-400/30 text-white hover:from-red-600 hover:to-red-700' : 'bg-gradient-to-br from-surface-100 to-surface-200/60 dark:from-surface-700 dark:to-surface-800/60 border-surface-200/80 dark:border-surface-600/80 text-surface-600 dark:text-surface-400 hover:border-surface-300/80 dark:hover:border-surface-500/80')"
                                (click)="toggleModoEliminacion()"
                                [disabled]="loading || creandoGeocerca || editandoGeocerca"
                                [pTooltip]="modoEliminacion ? 'Cancelar eliminación' : 'Eliminar geocercas'"
                                tooltipPosition="bottom">
                                <i [class]="'transition-transform duration-200 ' + (modoEliminacion ? 'pi pi-times' : 'pi pi-trash')"></i>
                            </button>
                        </div>

                        <!-- BARRA DE ACCIONES PARA MODO ELIMINACIÓN MEJORADA -->
                        @if (modoEliminacion) {
                            <div class="mt-4 relative overflow-hidden rounded-xl bg-gradient-to-br from-red-50 via-red-50/80 to-red-100/40 dark:from-red-900/20 dark:via-red-900/15 dark:to-red-800/10 border border-red-200/60 dark:border-red-700/40 p-4">
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-red-100/20 to-transparent dark:via-red-800/10"></div>

                                <div class="relative flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="selectAll"
                                                [checked]="todasSeleccionadas"
                                                (change)="toggleSeleccionarTodas()"
                                                class="w-4 h-4 text-red-600 bg-white dark:bg-surface-800 border-red-300 dark:border-red-600 rounded focus:ring-red-500 focus:ring-2">
                                            <label for="selectAll" class="ml-2.5 text-sm font-semibold text-red-700 dark:text-red-300">
                                                Seleccionar todas
                                            </label>
                                        </div>

                                        @if (tieneSelecciones) {
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full bg-red-100/80 dark:bg-red-800/30 border border-red-200/60 dark:border-red-700/40 text-xs font-semibold text-red-700 dark:text-red-300">
                                        {{ geocercasSeleccionadas.size }} seleccionada(s)
                                    </span>
                                        }
                                    </div>

                                    <!-- Botón eliminar seleccionadas mejorado -->
                                    <button
                                        class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold text-sm transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 border border-red-500/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                        [disabled]="!tieneSelecciones"
                                        (click)="confirmarEliminacion()">
                                        <i class="pi pi-trash text-sm"></i>
                                        Eliminar Seleccionadas
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Lista de Geocercas MEJORADA -->
                <div class="flex-1 overflow-y-auto min-h-0">
                    <!-- Loading Skeleton MEJORADO -->
                    @if (loading) {
                        <div class="space-y-3 p-3">
                            @for (item of [1, 2, 3, 4, 5]; track item) {
                                <div class="rounded-xl border border-surface-200/60 dark:border-surface-700/60 bg-gradient-to-br from-white via-surface-50/50 to-surface-100/20 dark:from-surface-800 dark:via-surface-800/80 dark:to-surface-900/40 p-4">
                                    <div class="flex items-center gap-4">
                                        <!-- Avatar skeleton -->
                                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-surface-200 to-surface-300 dark:from-surface-700 dark:to-surface-600 animate-pulse"></div>

                                        <!-- Content skeleton -->
                                        <div class="flex-1 space-y-2">
                                            <div class="flex gap-2">
                                                <div class="h-5 w-32 bg-surface-200 dark:bg-surface-700 rounded animate-pulse"></div>
                                                <div class="h-5 w-16 bg-surface-200 dark:bg-surface-700 rounded-full animate-pulse"></div>
                                            </div>
                                            <div class="h-4 w-3/4 bg-surface-200 dark:bg-surface-700 rounded animate-pulse"></div>
                                            <div class="h-3 w-1/2 bg-surface-200 dark:bg-surface-700 rounded animate-pulse"></div>
                                            <div class="flex gap-3">
                                                <div class="h-3 w-16 bg-surface-200 dark:bg-surface-700 rounded animate-pulse"></div>
                                                <div class="h-3 w-20 bg-surface-200 dark:bg-surface-700 rounded animate-pulse"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Lista Real de Geocercas MEJORADA -->
                    @if (!loading) {
                        <div class="space-y-3 p-3">
                            @for (geocerca of paginatedGeocercas; track geocerca) {
                                <div
                                    class="relative overflow-hidden rounded-xl border border-surface-200/80 dark:border-surface-600/80 bg-gradient-to-br from-white via-surface-50/60 to-surface-100/30 dark:from-surface-700 dark:via-surface-700/90 dark:to-surface-800/60 hover:from-primary-50/30 hover:via-white hover:to-primary-100/20 dark:hover:from-surface-600/80 dark:hover:via-surface-700/60 dark:hover:to-primary-900/20 transition-all duration-300 group hover:shadow-lg hover:border-primary-200/60 dark:hover:border-primary-600/60 hover:-translate-y-0.5"
                                    [class.from-primary-50]="selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion"
                                    [class.to-primary-100-40]="selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion"
                                    [class.border-primary-300-80]="selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion"
                                    [class.dark:from-primary-900-30]="selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion"
                                    [class.dark:to-primary-800-40]="selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion"
                                    [class.dark:border-primary-600-80]="selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion"
                                    [class.from-orange-50]="editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod"
                                    [class.to-orange-100-40]="editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod"
                                    [class.border-orange-300-80]="editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod"
                                    [class.dark:from-orange-900-30]="editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod"
                                    [class.dark:to-orange-800-40]="editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod"
                                    [class.dark:border-orange-600-80]="editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod"
                                    [class.from-red-50]="modoEliminacion && estaSeleccionada(geocerca.geoccod)"
                                    [class.to-red-100-40]="modoEliminacion && estaSeleccionada(geocerca.geoccod)"
                                    [class.border-red-300-80]="modoEliminacion && estaSeleccionada(geocerca.geoccod)"
                                    [class.dark:from-red-900-30]="modoEliminacion && estaSeleccionada(geocerca.geoccod)"
                                    [class.dark:to-red-800-40]="modoEliminacion && estaSeleccionada(geocerca.geoccod)"
                                    [class.dark:border-red-600-80]="modoEliminacion && estaSeleccionada(geocerca.geoccod)"
                                    [class.cursor-pointer]="!modoEliminacion && !editandoGeocerca">

                                    <!-- Background pattern sutil -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-surface-100/20 to-transparent dark:via-surface-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                                    <!-- Contenido principal del item -->
                                    <div class="relative flex items-center p-4"
                                         (click)="handleItemClick(geocerca)">

                                        <!-- Checkbox para modo eliminación -->
                                        @if (modoEliminacion) {
                                            <div class="flex-shrink-0 mr-4">
                                                <input
                                                    type="checkbox"
                                                    [checked]="estaSeleccionada(geocerca.geoccod)"
                                                    (change)="toggleSeleccionGeocerca(geocerca.geoccod)"
                                                    (click)="$event.stopPropagation()"
                                                    class="w-4 h-4 text-red-600 bg-white dark:bg-surface-800 border-red-300 dark:border-red-600 rounded focus:ring-red-500 focus:ring-2">
                                            </div>
                                        }

                                        <!-- Avatar/Icon con estado MEJORADO -->
                                        <div class="relative flex-shrink-0 mr-4">
                                            <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-gradient-to-br border shadow-sm"
                                                 [class]="getAvatarClasses(geocerca)">
                                                <i [class]="getAvatarIcon(geocerca)"></i>
                                            </div>
                                            <!-- Indicador de estado -->
                                            @if (geocerca.geocact) {
                                                <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white dark:border-surface-700 rounded-full">
                                                    <div class="w-full h-full bg-green-400 rounded-full animate-ping opacity-75"></div>
                                                </div>
                                            } @else {
                                                <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white dark:border-surface-700 rounded-full">
                                                    <div class="w-full h-full bg-red-400 rounded-full animate-ping opacity-75"></div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Info de la Geocerca MEJORADA -->
                                        <div class="flex-1 min-w-0">
                                            <!-- Código primero -->
                                            <div class="flex items-center gap-2 mb-2">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-surface-100/80 dark:bg-surface-600/60 border border-surface-200/60 dark:border-surface-500/60 text-xs font-mono font-medium text-surface-700 dark:text-surface-300">
                                            <i class="pi pi-hashtag mr-1 text-xs"></i>
                                            {{ geocerca.geoccod }}
                                        </span>

                                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold border shadow-sm"
                                                      [class]="getGeocercaStatusClasses(geocerca)">
                                            <div class="w-2 h-2 rounded-full mr-1.5"
                                                 [class]="geocerca.geocact ? 'bg-green-500' : 'bg-gray-400'"></div>
                                                    {{ getGeocercaStatusText(geocerca) }}
                                        </span>

                                                @if (editandoGeocerca && selectedGeocerca?.geoccod === geocerca.geoccod) {
                                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full bg-orange-100/80 text-orange-700 border border-orange-200/60 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-700/40 text-xs font-semibold">
                                                <i class="pi pi-pencil mr-1.5 text-xs"></i>
                                                Editando
                                            </span>
                                                }
                                            </div>

                                            <!-- Nombre (h6) -->
                                            <h6 class="font-bold text-surface-900 dark:text-surface-0 mb-2 text-base leading-tight group-hover:text-primary-700 dark:group-hover:text-primary-300 transition-colors">
                                                {{ geocerca.geocnom }}
                                            </h6>

                                            <!-- Ubicación -->
                                            <div class="space-y-1 mb-3">
                                                <div class="flex items-center gap-2 text-sm text-surface-600 dark:text-surface-400">
                                                    <div class="flex items-center justify-center w-5 h-5 rounded-md bg-blue-100/80 dark:bg-blue-900/30 border border-blue-200/40 dark:border-blue-700/40">
                                                        <i class="pi pi-map-marker text-blue-600 dark:text-blue-400 text-xs"></i>
                                                    </div>
                                                    <span class="font-medium">{{ geocerca.geocsec }}</span>
                                                </div>
                                                <div class="flex items-center gap-2 text-sm text-surface-600 dark:text-surface-400">
                                                    <div class="flex items-center justify-center w-5 h-5 rounded-md bg-emerald-100/80 dark:bg-emerald-900/30 border border-emerald-200/40 dark:border-emerald-700/40">
                                                        <i class="pi pi-globe text-emerald-600 dark:text-emerald-400 text-xs"></i>
                                                    </div>
                                                    <span class="font-medium">{{ geocerca.geocciud }}, {{ geocerca.geocprov }}</span>
                                                </div>
                                            </div>

                                            <!-- Métricas mejoradas -->
                                            <div class="flex items-center gap-4">
                                        <span class="inline-flex items-center gap-2 text-xs text-surface-500 dark:text-surface-500">
                                            <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
                                            {{ formatArea(geocerca.geocarm) }}
                                        </span>
                                                <span class="inline-flex items-center gap-2 text-xs text-surface-500 dark:text-surface-500">
                                            <div class="w-2 h-2 border-2 border-primary-500 rounded-full"></div>
                                                    {{ formatPerimeter(geocerca.geocperm) }}
                                        </span>
                                            </div>
                                        </div>

                                        <!-- Área de acciones MEJORADA -->
                                        @if (!modoEliminacion) {
                                            <div class="flex items-center gap-3 ml-3 flex-shrink-0">
                                                <!-- Botón de edición mejorado -->
                                                <button
                                                    class="w-10 h-10 flex items-center justify-center rounded-xl transition-all duration-200 border"
                                                    [class]="getEditButtonClasses(geocerca)"
                                                    (click)="quickEditGeocerca(geocerca, $event)"
                                                    [disabled]="getEditButtonDisabled(geocerca)"
                                                    pTooltip="Editar geocerca"
                                                    tooltipPosition="left">
                                                    <i class="pi pi-pencil text-sm"
                                                       [class]="getEditIconClasses(geocerca)"></i>
                                                </button>

                                                <!-- Indicador de selección mejorado -->
                                                <div class="flex items-center justify-center w-6">
                                                    @if (selectedGeocerca?.geoccod === geocerca.geoccod) {
                                                        <i class="pi pi-chevron-right text-primary-500 text-sm"></i>
                                                    } @else {
                                                        <i class="pi pi-chevron-right text-surface-300 dark:text-surface-600 text-sm opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                                    }
                                                </div>
                                            </div>
                                        } @else {
                                            <!-- Flecha simple para modo eliminación -->
                                            <i class="pi pi-chevron-right text-surface-400 flex-shrink-0 ml-3"></i>
                                        }
                                    </div>

                                    <!-- Indicador de estado en la parte inferior -->
                                    @if (selectedGeocerca?.geoccod === geocerca.geoccod && !modoEliminacion) {
                                        <div class="h-1 w-full"
                                             [class]="editandoGeocerca ? 'bg-gradient-to-r from-orange-200 to-orange-400 dark:from-orange-800 dark:to-orange-600' : 'bg-gradient-to-r from-primary-200 to-primary-400 dark:from-primary-800 dark:to-primary-600'">
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Mensaje si no hay geocercas MEJORADO -->
                            @if (filteredGeocercas.length === 0) {
                                <div class="text-center py-16">
                                    <div class="relative">
                                        <!-- Background decorativo -->
                                        <div class="absolute inset-0 bg-gradient-to-br from-surface-100/50 via-transparent to-surface-200/30 dark:from-surface-800/30 dark:to-surface-900/50 rounded-3xl"></div>

                                        <!-- Contenido -->
                                        <div class="relative p-12">
                                            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-surface-200 to-surface-300 dark:from-surface-700 dark:to-surface-800 rounded-2xl flex items-center justify-center border border-surface-300/60 dark:border-surface-600/60">
                                                <i class="pi pi-map text-3xl text-surface-500 dark:text-surface-400"></i>
                                            </div>
                                            <h6 class="text-surface-700 dark:text-surface-300 font-bold mb-3 text-base">
                                                No se encontraron geocercas
                                            </h6>
                                            <p class="text-surface-500 dark:text-surface-500 text-sm max-w-sm mx-auto leading-relaxed">
                                                Intenta ajustar tus filtros de búsqueda o crea nuevas geocercas
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Paginación adaptativa -->
                @if (!loading && filteredGeocercas.length > 0) {
                    <div class="p-2 sm:p-3 md:p-4 border-t border-surface-200/60 dark:border-surface-700/60 mt-auto flex-shrink-0">
                        <p-paginator
                            [rows]="itemsPerPage"
                            [totalRecords]="filteredGeocercas.length"
                            [first]="first"
                            (onPageChange)="onPageChange($event)"
                            class="text-xs sm:text-sm">
                        </p-paginator>
                    </div>
                }
            </div>
        </div>

        <!-- Panel Derecho - Mapa -->
        <div class="w-full lg:flex-1 flex flex-col order-1 lg:order-2">
            <div class="flex flex-col flex-1 overflow-hidden h-80 sm:h-96 lg:h-full bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-700 rounded-lg shadow-sm">

                <!-- Header: Buscador + botones -->
                <div class="flex flex-col gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-surface-50 to-white dark:from-surface-900 dark:to-surface-800 rounded-t-lg border-b border-surface-200 dark:border-surface-700">

                    <!-- Título, descripción y acciones alineados -->
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 p-3 sm:p-4 bg-gradient-to-r from-surface-50 to-white dark:from-surface-900 dark:to-surface-800 rounded-lg border border-surface-200 dark:border-surface-700">

                        <!-- Bloque de icono + texto -->
                        <div class="flex items-center gap-2 min-w-0">
                            <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-gradient-to-br from-primary-100 via-primary-200/60 to-primary-300/40 dark:from-primary-900/50 dark:via-primary-800/70 dark:to-primary-700/50 border border-primary-200/60 dark:border-primary-600/40 shadow-lg">
                                <i class="pi pi-map text-primary-600 dark:text-primary-300 text-xl"></i>
                            </div>
                            <div class="min-w-0 ">
                                <p class="text-gray-800 dark:text-white text-xl sm:text-2xl font-bold leading-snug tracking-tight">
                                    Geocercas
                                </p>

                                <p style="margin-top:-15px;" class="text-gray-500 dark:text-gray-400 text-xs sm:text-sm leading-snug">
                                    Mapa de geolocalización de geocercas activas
                                </p>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="flex gap-2 flex-shrink-0 items-center">
                            <button class="flex items-center justify-center h-9 w-9 rounded-full bg-white dark:bg-surface-800 hover:bg-primary-50 dark:hover:bg-primary-900/30 shadow-sm border border-surface-200 dark:border-surface-700 transition-all duration-200"
                                    (click)="refreshData()"
                                    pTooltip="Restablecer vista"
                                    tooltipPosition="bottom">
                                <i class="pi pi-refresh text-primary-500 dark:text-primary-400"></i>
                            </button>

                            <p-button
                                label="Crear Geocerca"
                                icon="pi pi-plus"
                                severity="primary"
                                size="small"
                                [disabled]="creandoGeocerca || !mapInitialized"
                                (click)="iniciarCreacionGeocerca()"
                                pTooltip="Crear nueva geocerca en el mapa"
                                tooltipPosition="bottom">
                            </p-button>
                        </div>
                    </div>

                    <!-- Panel de creación/edición de geocercas -->
                    @if (creandoGeocerca || editandoGeocerca) {
                        <div class="p-4 rounded-lg bg-primary-50/70 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="pi pi-map text-primary-600 dark:text-primary-400 text-lg"></i>
                                    <span class="font-medium text-primary-700 dark:text-primary-300">
                                {{ editandoGeocerca ? 'Editando Geocerca' : 'Creando Geocerca' }}
                            </span>
                                </div>
                                <p-button
                                    icon="pi pi-times"
                                    severity="danger"
                                    size="small"
                                    [text]="true"
                                    (click)="cancelarGestionGeocerca()"
                                    [pTooltip]="editandoGeocerca ? 'Cancelar edición' : 'Cancelar creación'"
                                    tooltipPosition="bottom">
                                </p-button>
                            </div>

                            <!-- Controles de geocerca en 3 columnas con Flexbox -->
                            <div class="flex flex-col md:flex-row gap-4 mb-3">
                                <!-- Columna 1: Tipo de geocerca -->
                                <div class="flex-1">
                                    <label class="block text-xs font-medium text-surface-700 dark:text-surface-300 mb-1">
                                        Tipo de Geocerca
                                    </label>
                                    <p-select
                                        [(ngModel)]="tipoGeocerca"
                                        [options]="tiposGeocerca"
                                        optionLabel="label"
                                        optionValue="value"
                                        (onChange)="onTipoGeocercaChange()"
                                        class="w-full">
                                        <ng-template pTemplate="item" let-option>
                                            <div class="flex items-center gap-2">
                                                <i [class]="option.icon"></i>
                                                <span>{{ option.label }}</span>
                                            </div>
                                        </ng-template>
                                    </p-select>
                                </div>

                                <!-- Columna 2: Radio para círculo -->
                                @if (tipoGeocerca === 'circular') {
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium text-surface-700 dark:text-surface-300 mb-2">
                                            Radio: {{ radioGeocerca }} metros
                                        </label>
                                        <p-slider
                                            [(ngModel)]="radioGeocerca"
                                            (onSlideEnd)="actualizarRadioCirculo()"
                                            [min]="50"
                                            [max]="2000"
                                            [step]="10"
                                            class="w-full">
                                        </p-slider>
                                        <div class="flex justify-between text-xs text-surface-500 mt-1">
                                            <span>50m</span>
                                            <span>2000m</span>
                                        </div>
                                    </div>
                                }

                                <!-- Columna 3: Estado del polígono -->
                                @if (tipoGeocerca === 'poligono' && coordenadasGeocerca.length > 0) {
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <div class="text-xs text-surface-600 dark:text-surface-400">
                                                Puntos agregados: {{ coordenadasGeocerca.length }}
                                                @if (coordenadasGeocerca.length >= 3) {
                                                    <span class="text-green-600 dark:text-green-400 ml-2">
                                                ✓ Listo para continuar
                                            </span>
                                                }
                                            </div>
                                            <p-button
                                                icon="pi pi-undo"
                                                severity="secondary"
                                                size="small"
                                                [text]="true"
                                                (click)="deshacerUltimoPunto()"
                                                [disabled]="coordenadasGeocerca.length === 0"
                                                pTooltip="Deshacer último punto"
                                                tooltipPosition="bottom">
                                            </p-button>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Instrucciones -->
                            <div class="mb-3 p-2 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800">
                                <div class="text-xs text-blue-700 dark:text-blue-300">
                                    <i class="pi pi-info-circle mr-1"></i>
                                    @if (tipoGeocerca === 'circular') {
                                        <span>
                                    <strong>Círculo:</strong> Haga clic en el mapa para colocar el centro, luego ajuste el radio con el slider
                                </span>
                                    }
                                    @if (tipoGeocerca === 'poligono') {
                                        <span>
                                    <strong>Polígono:</strong> Haga clic en el mapa para agregar puntos numerados (mínimo 3).
                                    Use <i class="pi pi-undo"></i> para deshacer el último punto.
                                </span>
                                    }
                                </div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="flex gap-2">
                                <p-button
                                    label="Limpiar"
                                    icon="pi pi-refresh"
                                    severity="secondary"
                                    size="small"
                                    [text]="true"
                                    (click)="limpiarDibujo()">
                                </p-button>
                                <p-button
                                    [label]="editandoGeocerca ? 'Guardar Cambios' : 'Continuar'"
                                    [icon]="editandoGeocerca ? 'pi pi-save' : 'pi pi-arrow-right'"
                                    severity="primary"
                                    size="small"
                                    (click)="editandoGeocerca ? abrirDialogoEdicion() : abrirDialogoGeocerca()"
                                    [disabled]="!puedeFinalizarGeocerca">
                                </p-button>
                            </div>
                        </div>
                    }

                    <!-- Buscador de Ubicaciones -->
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div class="flex-1 min-w-0">
                            <p-iconField iconPosition="left" class="w-full">
                                <p-inputIcon>
                                    <i class="pi pi-map-marker"></i>
                                </p-inputIcon>
                                <input
                                    pInputText
                                    type="text"
                                    placeholder="Buscar ubicación (ej: Quito, Ecuador)"
                                    [(ngModel)]="searchLocation"
                                    (keyup.enter)="searchLocationOnMap()"
                                    class="w-full text-sm"
                                    #locationInput>
                            </p-iconField>
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            <p-button icon="pi pi-search"
                                      severity="primary"
                                      size="small"
                                      (click)="searchLocationOnMap()"
                                      [loading]="searchingLocation"
                                      pTooltip="Buscar ubicación"
                                      tooltipPosition="bottom">
                            </p-button>
                            <p-button icon="pi pi-times"
                                      severity="secondary"
                                      size="small"
                                      [text]="true"
                                      (click)="clearLocationSearch()"
                                      pTooltip="Limpiar búsqueda"
                                      tooltipPosition="bottom">
                            </p-button>
                        </div>
                    </div>

                    <!-- Resultados de búsqueda -->
                    @if (searchResults.length > 0) {
                        <div class="bg-surface-50 dark:bg-surface-800 rounded-lg p-3">
                            <div class="text-xs sm:text-sm text-surface-600 dark:text-surface-400 mb-2">
                                Resultados de búsqueda:
                            </div>
                            <div class="space-y-1">
                                @for (result of searchResults.slice(0, 3); track result) {
                                    <div
                                        class="flex items-center justify-between p-2 hover:bg-surface-100 dark:hover:bg-surface-700 rounded cursor-pointer transition-colors"
                                        (click)="selectSearchResult(result)">
                                        <div class="flex items-center gap-2 min-w-0 flex-1">
                                            <i class="pi pi-map-marker text-primary text-sm flex-shrink-0"></i>
                                            <span class="text-xs sm:text-sm text-surface-900 dark:text-surface-0 truncate">{{ result.display_name }}</span>
                                        </div>
                                        <i class="pi pi-arrow-right text-surface-400 text-xs flex-shrink-0 ml-2"></i>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Contenedor del Mapa -->
                <div class="flex-1 relative overflow-hidden min-h-0">
                    <!-- Loading del mapa -->
                    @if (!mapInitialized) {
                        <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-surface-100/50 via-transparent to-surface-200/30 dark:from-surface-800/30 dark:to-surface-900/50 z-10">
                            <div class="text-center p-8">
                                <div class="relative">
                                    <!-- Background decorativo -->
                                    <div class="absolute inset-0 bg-gradient-to-br from-surface-100/50 via-transparent to-surface-200/30 dark:from-surface-800/30 dark:to-surface-900/50 rounded-2xl"></div>

                                    <!-- Contenido -->
                                    <div class="relative p-8">
                                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-primary-100 to-primary-200 dark:from-primary-900/40 dark:to-primary-800/60 rounded-2xl flex items-center justify-center border border-primary-200/60 dark:border-primary-700/40">
                                            <i class="pi pi-spin pi-spinner text-2xl text-primary-600 dark:text-primary-400"></i>
                                        </div>
                                        <h6 class="text-surface-700 dark:text-surface-300 font-bold mb-2">
                                            Cargando mapa
                                        </h6>
                                        <p class="text-sm text-surface-500 dark:text-surface-500 max-w-sm mx-auto leading-relaxed">
                                            Preparando la visualización de ubicaciones...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Mapa de Leaflet -->
                    <div #mapContainer
                         class="w-full h-full rounded-b-lg"
                         style="min-height: 700px; height: 100%; width: 100%;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<p-dialog
    [(visible)]="geocercaDialog"
    [style]="{ width: '600px' }"
    [header]="editandoGeocerca ? 'Editar Geocerca' : 'Completar datos de la Geocerca'"
    [modal]="true"
    class="p-fluid">

    <ng-template pTemplate="content">
        <form [formGroup]="geocercaForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- Código de Geocerca -->
                <div>
                    <label for="geoccod" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Código de la Geocerca *
                    </label>

                    <div class="relative">
                        <input
                            maxlength="5"
                            id="geoccod"
                            pInputText
                            formControlName="geoccod"
                            placeholder="Ej: GEO001"
                            [class]="getCodeInputClass()"
                            class="w-full" />

                        <!-- Icono de estado -->
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            @if (validatingCode) {
                                <i class="pi pi-spin pi-spinner text-primary-500"></i>
                            }

                            @if (codeValidationResult === 'valid') {
                                <i class="pi pi-check-circle text-green-500"></i>
                            }

                            @if (codeValidationResult === 'invalid') {
                                <i class="pi pi-times-circle text-red-500"></i>
                            }
                        </div>
                    </div>

                    <!-- Mensaje de validación mejorado -->
                    <div class="mt-1 min-h-[20px]">
                        @if (validatingCode) {
                            <p class="text-xs text-surface-500 flex items-center gap-1">
                                <i class="pi pi-spin pi-spinner"></i>
                                Validando código...
                            </p>
                        }

                        @if (codeValidationMessage && !validatingCode) {
                            <p [class]="getValidationMessageClass()">
                                @if (codeValidationResult === 'valid') {
                                    <i class="pi pi-check mr-1"></i>
                                }
                                @if (codeValidationResult === 'invalid') {
                                    <i class="pi pi-exclamation-triangle mr-1"></i>
                                }
                                {{ codeValidationMessage }}
                            </p>
                        }
                    </div>
                </div>

                <!-- Nombre -->
                <div>
                    <label for="geocnom" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Nombre de la Geocerca *
                    </label>
                    <input
                        id="geocnom"
                        pInputText
                        formControlName="geocnom"
                        placeholder="Ej: Zona Norte"
                        class="w-full">
                </div>

                <!-- Provincia -->
                <div>
                    <label for="geocprov" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Provincia *
                    </label>
                    <p-autocomplete
                        inputId="geocprov"
                        formControlName="geocprov"
                        [suggestions]="provinciasFiltradas"
                        optionLabel="provincia"
                        placeholder="Buscar provincia..."
                        (completeMethod)="filtrarProvincias($event)"
                        (onSelect)="onProvinciaSeleccionada($event)"
                        (onClear)="onProvinciaLimpiada()"
                        [dropdown]="true"
                        class="w-full">
                    </p-autocomplete>
                </div>

                <!-- Ciudad -->
                <div>
                    <label for="geocciud" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Ciudad *
                    </label>
                    <p-autocomplete
                        inputId="geocciud"
                        formControlName="geocciud"
                        [suggestions]="ciudadesFiltradas"
                        optionLabel="canton"
                        placeholder="Buscar ciudad/cantón..."
                        (completeMethod)="filtrarCiudades($event)"
                        (onSelect)="onCiudadSeleccionada($event)"
                        (onClear)="onCiudadLimpiada()"
                        [dropdown]="true"
                        [disabled]="!provinciaSeleccionada"
                        class="w-full">
                    </p-autocomplete>
                </div>

                <!-- Sector -->
                <div>
                    <label for="geocsec" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Sector *
                    </label>
                    <p-autocomplete
                        inputId="geocsec"
                        formControlName="geocsec"
                        [suggestions]="sectoresFiltrados"
                        optionLabel="parroquia"
                        placeholder="Buscar sector/parroquia..."
                        (completeMethod)="filtrarSectores($event)"
                        [dropdown]="true"
                        [disabled]="!ciudadSeleccionada"
                        class="w-full">
                    </p-autocomplete>
                </div>

                <!-- Dirección de referencia -->
                <div class="md:col-span-2">
                    <label for="geocdirre" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Dirección de Referencia *
                    </label>
                    <input
                        id="geocdirre"
                        pInputText
                        formControlName="geocdirre"
                        placeholder="Ej: Av. Principal y Calle 10"
                        class="w-full">
                </div>

                <!-- País -->
                <div>
                    <label for="geocpais" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        País *
                    </label>
                    <input
                        readonly
                        id="geocpais"
                        pInputText
                        formControlName="geocpais"
                        value="ECUADOR"
                        class="w-full">
                </div>

                <!-- Prioridad -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label for="geocpri" class="text-sm font-medium text-surface-700 dark:text-surface-300">
                            Prioridad (1-10) *
                        </label>
                        <span class="px-2 py-1 text-sm font-bold text-primary-600 bg-primary-50 rounded">
                            {{ geocercaForm.get('geocpri')?.value || 1 }}
                        </span>
                    </div>
                    <p-slider
                        id="geocpri"
                        formControlName="geocpri"
                        [min]="1"
                        [max]="10"
                        [step]="1"
                        class="w-full">
                    </p-slider>
                    <div class="flex justify-between text-xs text-surface-500 mt-1">
                        <span>Baja</span>
                        <span>Alta</span>
                    </div>
                </div>

                <!-- Estado activo -->
                <div class="flex items-center gap-2 mt-6">
                    <p-toggleSwitch
                        formControlName="geocact"
                        inputId="geocact">
                    </p-toggleSwitch>
                    <label for="geocact" class="text-sm font-medium text-surface-700 dark:text-surface-300">
                        Geocerca activa
                    </label>
                </div>

                <!-- Descripción -->
                <div class="md:col-span-2">
                    <label for="geocdesc" class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">
                        Descripción *
                    </label>
                    <textarea
                        id="geocdesc"
                        pInputTextarea
                        formControlName="geocdesc"
                        placeholder="Descripción detallada de la geocerca"
                        rows="3"
                        class="w-full">
                    </textarea>
                </div>
            </div>

            <!-- Resumen de la geocerca -->
            <div class="mt-4 p-3 bg-surface-50 dark:bg-surface-800 rounded border">
                <h4 class="text-sm font-medium text-surface-700 dark:text-surface-300 mb-2">Resumen de la Geocerca</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <span class="text-surface-600 dark:text-surface-400">Tipo:</span>
                        <span class="ml-2 font-medium">{{ tipoGeocerca === 'circular' ? 'Circular' : 'Polígono' }}</span>
                    </div>
                    <div>
                        <span class="text-surface-600 dark:text-surface-400">Puntos:</span>
                        <span class="ml-2 font-medium">{{ coordenadasGeocerca.length }}</span>
                    </div>
                    <div>
                        <span class="text-surface-600 dark:text-surface-400">Centro:</span>
                        <span class="ml-2 font-medium">{{ centroGeocerca?.lat?.toFixed(6) || 'N/A' }}, {{ centroGeocerca?.lng?.toFixed(6) || 'N/A' }}</span>
                    </div>
                    <div>
                        <span class="text-surface-600 dark:text-surface-400">Empresa:</span>
                        <span class="ml-2 font-medium">{{ enterpriseName }}</span>
                    </div>
                </div>
            </div>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <p-button
                label="Cancelar"
                icon="pi pi-times"
                severity="secondary"
                [text]="true"
                (click)="cerrarDialogoGeocerca()">
            </p-button>
            <p-button
                [label]="editandoGeocerca ? 'Actualizar Geocerca' : 'Crear Geocerca'"
                [icon]="editandoGeocerca ? 'pi pi-save' : 'pi pi-check'"
                severity="primary"
                (click)="editandoGeocerca ? actualizarGeocerca() : guardarGeocerca()"
                [disabled]="geocercaForm.invalid || (!editandoGeocerca && codeValidationResult !== 'valid')">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>

